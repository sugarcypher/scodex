name: ğŸš€ Master Deploy - Sugar Codex

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  BUN_VERSION: 'latest'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸŸ¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "Installing frontend dependencies..."
          cd frontend
          bun install
          echo "Dependencies installed successfully!"
          
      - name: ğŸ—ï¸ Build Web Version
        run: |
          echo "Building Sugar Codex web version..."
          cd frontend
          npx expo export --platform web --clear
          echo "Build completed successfully!"
          
      - name: ğŸ” Verify Build Output
        run: |
          echo "Verifying build output..."
          cd frontend/dist
          ls -la
          echo "JavaScript bundle:"
          ls -la _expo/static/js/web/
          echo "Assets:"
          ls -la assets/
          echo "Build verification complete!"
          
      - name: ğŸ“„ Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './frontend/dist'
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: âœ… Deployment Complete
        run: |
          echo "ğŸ‰ Sugar Codex deployed successfully!"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“± App should now work without white screen!"
